<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jn.enterprise.servicemarket.org.dao.OrgMapper">
    <select id="selectServiceOrgList" parameterType="com.jn.enterprise.servicemarket.org.model.OrgParameter"
            resultType="com.jn.enterprise.model.ServiceOrg">
        select tt.orgId,tt.orgName,tt.orgLogo,tt.pageviews,tt.orgRegisterTime,tt.isApprove,tt.orgType,orgPhone,tt.orgSpeciality,
        tt.orgAddress,tt.transactionNum,tt.attitudeScore,tt.evaluationNum from
        (select
        a.org_id_ as "orgId",a.org_name as "orgName",a.org_speciality as "orgSpeciality",
        a.org_logo as "orgLogo",a.org_show as "pageviews",
        date_format(a.org_register_time,'%Y-%m-%d') as "orgRegisterTime",
        a.is_approve as "isApprove",a.org_type as "orgType", i.org_phone as "orgPhone",
        CONCAT(i.org_province,i.org_city,i.org_area,i.org_address) as "orgAddress",
        (select count(1) from tb_service_require t where t.org_id_ = a.org_id_ and t.record_status = '1' and t.handle_result = '1' ) as "transactionNum" <!-- 累计交易笔数 -->
        ,(SELECT IFNULL(AVG(t.`attitude_score`), 0) FROM tb_service_rating t
        WHERE t.org_id_ = a.org_id_)  AS "attitudeScore" <!-- 评价得分 -->
        ,(SELECT COUNT(1) FROM tb_service_rating t WHERE t.org_id_ = a.org_id_)  AS "evaluationNum"  <!-- 评价次数 -->
        from tb_service_org a left join tb_service_org_info i on a.org_id_ = i.org_id_ LEFT JOIN tb_service_org_trait tr ON a.org_id_ = tr.org_id_
        where 1=1 and a.record_status != '0'

        <if test="businessType != null and businessType.length>0">
            AND a.business_type IN
            <foreach item="item" index="index" collection="businessType" open="("  close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="businessSType != null and businessSType != ''">
            and a.business_s_type = #{businessSType}
        </if>
        <if test="templateId != null and templateId != ''">
            and a.org_id_ in (
            select distinct
            ssp.org_id_
            from tb_service_product ssp
            where ssp.record_status='1' and ssp.template_id = #{templateId}
            )

        </if>
        <if test="orgName != null and orgName != ''">
            and a.org_name like CONCAT('%', #{orgName}, '%')
        </if>
        <if test="orgBusiness != null and orgBusiness != ''">
            and a.org_business = #{orgBusiness}
        </if>
        <if test="companyList != null and companyList.size()>0">
            AND tr.trait_value IN
            <foreach item="item" index="index" collection="companyList" open="("  close=")" separator=",">
                #{item}
          </foreach>
        </if>
        GROUP BY a.org_id_
        <if test="sortTypes =='popularity'">
            ORDER BY <!-- 人气排序-->
            a.org_show DESC   <!-- 浏览量-->
        </if>
        )tt
        <if test="sortTypes =='integrate' or sortTypes ==null or sortTypes == ''">
            ORDER BY tt.attitudeScore DESC <!--综合排序结果值-->
        </if>
        <if test="sortTypes =='serviceNum'">
            ORDER BY <!-- 服务量排序-->
            tt.transactionNum DESC <!-- 累计交易数-->
        </if>
        <if test="sortTypes =='attitudeScore'">
            ORDER BY <!-- 好评排序-->
            tt.attitudeScore DESC
        </if>
    </select>

    <resultMap id="queryServiceOrgDetailMap" type="com.jn.enterprise.servicemarket.org.vo.OrgDetailVo">
        <id column="s_id" jdbcType="VARCHAR" property="orgId" javaType="java.lang.String"/>
        <result column="s_businessType" jdbcType="VARCHAR" property="businessType" javaType="java.lang.String"/>
        <result column="s_businessSType" jdbcType="VARCHAR" property="businessSType" javaType="java.lang.String"/>
        <result column="s_orgName" jdbcType="VARCHAR" property="orgName" javaType="java.lang.String"/>
        <result column="s_orgBusiness" jdbcType="VARCHAR" property="orgBusiness" javaType="java.lang.String"/>
        <result column="s_orgSynopsis" jdbcType="VARCHAR" property="orgSynopsis" javaType="java.lang.String"/>
        <result column="s_orgStatus" jdbcType="VARCHAR" property="orgStatus" javaType="java.lang.String"/>
        <result column="s_orgShow" jdbcType="VARCHAR" property="orgShow" javaType="java.lang.String"/>
        <result column="s_transactionCount" jdbcType="VARCHAR" property="transactionCount" javaType="java.lang.String"/>
        <result column="s_orgServiceScore" jdbcType="VARCHAR" property="orgServiceScore" javaType="java.lang.String"/>
        <result column="s_orgHobby" jdbcType="VARCHAR" property="orgHobby" javaType="java.lang.String"/>
        <result column="s_orgSpeciality" jdbcType="VARCHAR" property="orgSpeciality" javaType="java.lang.String"/>
        <result column="s_operateStatus" jdbcType="VARCHAR" property="operateStatus" javaType="java.lang.String"/>
        <result column="s_orgPrincipal" jdbcType="VARCHAR" property="orgPrincipal" javaType="java.lang.String"/>
        <result column="s_orgBusinType" jdbcType="VARCHAR" property="orgBusinType" javaType="java.lang.String"/>
        <result column="s_orgBusinAddresse" jdbcType="VARCHAR" property="orgBusinAddresse" javaType="java.lang.String"/>
        <result column="s_orgBusinScope" jdbcType="VARCHAR" property="orgBusinScope" javaType="java.lang.String"/>
        <result column="s_orgWeb" jdbcType="VARCHAR" property="orgWeb" javaType="java.lang.String"/>
        <result column="s_orgSpeciality" jdbcType="VARCHAR" property="orgSpeciality" javaType="java.lang.String"/>
        <result column="s_professionNum" jdbcType="VARCHAR" property="professionNum" javaType="java.lang.Integer"/>
        <result column="s_staffCount" jdbcType="VARCHAR" property="staffCount" javaType="java.lang.Integer"/>
        <result column="s_bachelorNum" jdbcType="VARCHAR" property="bachelorNum" javaType="java.lang.Integer"/>
        <result column="s_masterNum" jdbcType="VARCHAR" property="masterNum" javaType="java.lang.Integer"/>
        <result column="s_doctorNum" jdbcType="VARCHAR" property="doctorNum" javaType="java.lang.Integer"/>
        <result column="s_returneeNum" jdbcType="VARCHAR" property="returneeNum" javaType="java.lang.Integer"/>
        <result column="s_orgPhone" jdbcType="VARCHAR" property="orgPhone" javaType="java.lang.String"/>
        <result column="s_orgAddress" jdbcType="VARCHAR" property="orgAddress" javaType="java.lang.String"/>
        <result column="s_conName" jdbcType="VARCHAR" property="conName" javaType="java.lang.String"/>
        <result column="s_conPhone" jdbcType="VARCHAR" property="conPhone" javaType="java.lang.String"/>
        <result column="s_conEmail" jdbcType="VARCHAR" property="conEmail" javaType="java.lang.String"/>
        <result column="s_orgRegisterTime" jdbcType="VARCHAR" property="orgRegisterTime" javaType="java.lang.String"/>
        <result column="s_orgLogo" jdbcType="VARCHAR" property="orgLogo" javaType="java.lang.String"/>
        <result column="evaluationScore" jdbcType="VARCHAR" property="evaluationScore" javaType="java.lang.String"/>
        <result column="evaluationNum" jdbcType="VARCHAR" property="evaluationNum" javaType="java.lang.Integer"/>
        <result column="position" jdbcType="VARCHAR" property="position" javaType="java.lang.String"/>

        <!-- 执业标签 -->
        <collection property="orgLicenses" javaType="java.util.List"
                    ofType="com.jn.enterprise.servicemarket.org.model.OrgLicense">
            <id column="st_id" property="id" jdbcType="VARCHAR"/>
            <result column="st_certName" property="certName" jdbcType="VARCHAR"/>
            <result column="st_fileUrl" property="fileUrl" jdbcType="VARCHAR"/>
            <result column="st_isFeatures" property="isFeatures" jdbcType="VARCHAR"/>
            <result column="st_awardTime" property="awardTime" jdbcType="VARCHAR"/>
            <result column="st_certType" property="certType" jdbcType="VARCHAR"/>
        </collection>
        <!-- 执业资质 -->
        <collection property="honorLicense" javaType="java.util.List"
                    ofType="com.jn.enterprise.servicemarket.org.model.OrgLicense">
            <id column="sh_id" property="id" jdbcType="VARCHAR"/>
            <id column="sh_orgId" property="orgId" jdbcType="VARCHAR"/>
            <result column="sh_certName" property="certName" jdbcType="VARCHAR"/>
            <result column="sh_fileUrl" property="fileUrl" jdbcType="VARCHAR"/>
            <result column="sh_isFeatures" property="isFeatures" jdbcType="VARCHAR"/>
            <result column="sh_awardTime" property="awardTime" jdbcType="VARCHAR"/>
            <result column="sh_certType" property="certType" jdbcType="VARCHAR"/>
        </collection>
        <!-- 团队信息 -->
        <collection property="orgTeams" javaType="java.util.List"
                    ofType="com.jn.enterprise.servicemarket.org.model.OrgTeam">
            <id column="te_id" property="orgId" jdbcType="VARCHAR"/>
            <result column="te_orgId" property="orgId" jdbcType="VARCHAR"/>
            <result column="te_conName" property="conName" jdbcType="VARCHAR"/>
            <result column="te_conPosition" property="conPosition" jdbcType="VARCHAR"/>
            <result column="te_conQuali" property="conQuali" jdbcType="VARCHAR"/>
            <result column="te_conTime" property="conTime" jdbcType="VARCHAR"/>
            <result column="te_conSpeciality" property="conSpeciality" jdbcType="VARCHAR"/>
        </collection>
    </resultMap>

    <!--查看服务商详情-->
    <select id="getServiceOrgDetail" resultMap="queryServiceOrgDetailMap" parameterType="java.lang.String">
        SELECT
          o.org_id_ AS "s_id",
         (SELECT pre.pre_value FROM tb_service_prefer pre WHERE pre.id = o.business_type )AS "s_businessType",
          o.business_s_type AS "s_businessSType",
          o.org_name AS "s_orgName",
          o.org_business AS "s_orgBusiness",
          o.org_synopsis AS "s_orgSynopsis",
          o.org_status AS "s_orgStatus",
          o.org_show AS "s_orgShow",
          (select count(1) from tb_service_require tr where tr.org_id_ = o.org_id_ and tr.record_status = '1' and tr.handle_result = '1' ) AS "s_transactionCount",
          (SELECT(SUM(attitude_score) / COUNT(1)) FROM tb_service_rating ra WHERE ra.org_id_ = o.org_id_) AS "s_orgServiceScore",
          o.org_hobby AS "s_orgHobby",
          o.org_speciality AS "s_orgSpeciality",
          o.operate_status AS "s_operateStatus",
          o.org_principal AS "s_orgPrincipal",
          o.org_busin_type AS "s_orgBusinType",
          o.org_busin_address AS "s_orgBusinAddresse",
          o.org_busin_scope AS "s_orgBusinScope",
          o.org_code AS "s_orgCode",
          el.staff_count AS "s_staffCount",
          el.profession_num AS "s_professionNum",
          el.bachelor_num AS "s_bachelorNum",
          el.master_num AS "s_masterNum",
          el.doctor_num AS "s_doctorNum",
          el.returnee_num AS "s_returneeNum",
          i.org_phone AS "s_orgPhone",
          CONCAT(
            i.org_province,
            i.org_city,
            i.org_area,
            i.org_address
          ) AS "s_orgAddress",
          i.con_name AS "s_conName",
          i.con_phone AS "s_conPhone",
          i.con_email AS "s_conEmail",
          i.org_web as "s_orgWeb",
          date_format(o.org_register_time,'%Y-%m-%d')  AS "s_orgRegisterTime",
          o.org_logo AS "s_orgLogo",
          li.id AS "sh_id",
          li.org_id_ AS "sh_orgId",
          li.cert_name AS "sh_certName",
          li.file_url AS "sh_fileUrl",
          li.is_features "AS sh_isFeatures",
          date_format(li.award_time,'%Y-%m-%d') AS "sh_awardTime",
          li.cert_type AS "sh_certType",
          te.id as "te_id",
          te.org_id_ as "te_orgId",
          te.con_name as "te_conName",
          te.con_position as "te_conPosition",
          te.con_quali as "te_conQuali",
          te.con_time as "te_conTime",
          te.con_speciality as "te_conSpeciality"
          ,IFNULL(AVG(sr.`attitude_score`),0) AS "evaluationScore"		      <!-- 评价分数-->
          ,COUNT(sr.`attitude_score`) AS "evaluationNum"			          <!-- 评价次数-->
          ,sa.position as "position"                                          <!-- 职务-->
        FROM
          tb_service_org o
          LEFT JOIN tb_service_org_license lic
            ON o.org_id_ = lic.org_id_ and lic.is_features = '1' and lic.record_status = 1
            LEFT JOIN tb_service_org_license li
            ON o.org_id_ = li.org_id_ and li.record_status = 1
          LEFT JOIN tb_service_org_element el
            ON el.org_id_ = o.org_id_ and el.record_status = 1
          LEFT JOIN tb_service_org_info i
            ON i.org_id_ = o.org_id_ and i.record_status = 1
          left join tb_service_org_team te on te.org_id_ = o.org_id_ and te.record_status = 1
          LEFT JOIN tb_service_rating sr on o.org_id_=sr.org_id_
          left join tb_service_advisor sa
        on i.org_id_=sa.org_id_ and i.con_name=sa.advisor_name
        where o.record_status = 1 and o.org_id_ = #{orgId}
    </select>
    <!--机构的顾问数,产品数统计-->
    <select id="getMyOrgInfo" resultType="com.jn.enterprise.servicemarket.org.model.OrgCount">
        select count(t1.org_id_) as "productNum",
       (select count(t2.org_id_) from tb_service_advisor t2 where t2.org_id_=#{orgId}) as "advisorNum"
            from tb_service_product t1
               where t1.org_id_ = #{orgId}
    </select>

    <!--根据产品查询服务机构统计数据-->
    <select id="getProductOrgNum" resultType="java.lang.String">
        SELECT
          SUM(t.num) AS "orgNum"
        FROM
          (SELECT
            COUNT(org_id_) AS 'num'
          FROM
            tb_service_product t
          WHERE t.status = '1'
            AND t.record_status = '1'
            AND t.template_id = #{productId}
          GROUP BY t.org_id_) t
    </select>

    <!--根据业务领域/产品查询评价统计数据-->
    <select id="getProductRatingNum" resultType="java.lang.String" parameterType="com.jn.enterprise.servicemarket.org.vo.BusinessStatisticalParam">
        SELECT COUNT(1) FROM tb_service_rating r WHERE r.product_id IN (
		    SELECT t.product_id FROM tb_service_product t WHERE  t.status = '1' AND t.record_status = '1'
            <if test="productId != null and productId != ''">
                and t. template_id= #{productId}
            </if>

            <if test="businessType != null and businessType != ''">
                and t.signory_id = #{businessType}
            </if>
		    GROUP BY t.product_id
	    ) AND r.record_status = '1'
    </select>

    <!--根据产品查询顾问统计数据-->
    <select id="getProductAdvisorNum" resultType="java.lang.String">
        select
        count(sa.advisor_account)
        from tb_service_product sp
        join tb_service_and_advisor saa
            on sp.product_id=saa.product_id
        join tb_service_advisor sa
            on sa.advisor_account=saa.advisor_account
            and sa.approval_status='2'
            and sa.record_status='1'
        where sp.template_id  =#{productId}
    </select>



    <!--根据产品查询需求(交易量)统计数据-->
    <select id="getProductNum" resultType="java.lang.String">
        select
        count(sr.req_num)
        from tb_service_product sp
        left join tb_service_require sr
            on sp.product_id=sr.product_id
            and sr.status='2'
            and sr.record_status='1'
        where sp.template_id  =#{productId}
    </select>

</mapper>