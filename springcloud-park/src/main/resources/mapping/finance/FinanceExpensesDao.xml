<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jn.park.finance.dao.FinanceExpensesDao">

    <!--支出录入查询-->
    <select id="findAll" parameterType="com.jn.park.finance.model.FinanceExpensesPageModel" resultType="com.jn.park.finance.vo.FinanceExpendVo">
        SELECT t.cost_happend_time as "costhappendtime",
        t.cost as "cost",
        t.cost_after_type_name as "costaftertypename",
        IFNULL(t.modified_time,t.cost_happend_time)  as "modifiedtime",
        t.department_name as "departmentname"
        FROM `tb_finance_expenses_month` t
        where t.department_id=#{departmentId}
        and t.record_status ='1'
        <!--and t.cost_after_type_id=#{costAfterTypeId}-->
        and t.cost_happend_time BETWEEN #{startTime} and  #{endTime}
    </select>


    <!--支出录入历史查询-->
    <select id="findHistoryAll" parameterType="com.jn.park.finance.model.FinanceExpensesHistoryPageModel" resultType="com.jn.park.finance.vo.FinanceExpendHistoryVo">
        SELECT t.cost_happend_time as "costhappendtime",
        t.cost_id as "costid",
        t.cost as "cost",
        t.cost_before_type_name as "costbeforetypename",
        t.cost_after_type_name as "costaftertypename",
        t.created_time as "createdtime",
        t.department_name as "departmentname"
         from tb_finance_expenses_temp t
        WHERE t.record_status=1
        AND t.cost_id like concat(concat("%",#{costId}),"%")
        AND t.department_id=#{departmentId}
        AND t.cost_happend_time BETWEEN #{startTime} and  #{endTime}
    </select>

    <!--导入 到临时表-->
    <insert id="importData" parameterType="java.util.Map">
        insert into tb_finance_expenses_temp (cost_happend_time,cost,cost_id,excel_id,cost_before_type_name,cost_after_type_id,cost_after_type_name,department_id,department_name,creator_account,created_time)values
        <foreach collection="list" item="item" index="index" open="" close="" separator=",">
            (
            <choose>
                <when test="item.costHappendTime != null" >
                    '${item.costHappendTime}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.cost != null" >
                    '${item.cost}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costId != null" >
                    '${item.costId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.excelId != null" >
                    '${item.excelId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costBeforeTypeName != null" >
                    '${item.costBeforeTypeName}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costAfterTypeId != null" >
                    '${item.costAfterTypeId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costAfterTypeName != null" >
                    '${item.costAfterTypeName}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.departmentId != null" >
                    '${item.departmentId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.departmentName != null" >
                    '${item.departmentName}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            #{account},
            SYSDATE()
            )
        </foreach>
    </insert>

    <!--支出录入查询-->
    <select id="findImportData" parameterType="java.lang.String" resultType="com.jn.park.finance.vo.FinanceExpendFindImportDataVo">

        SELECT
		t.id as "id",
		t.cost_happend_time as "costhappendtime",
		t.cost_id as "costid",
		t.cost as "cost",
		t.cost_before_type_name as "costbeforetypename",
		t.cost_after_type_id as "costaftertypeid",
		t.cost_after_type_name  as "costaftertypename",
		t.department_id as "departmentid",
		t.department_name as "departmentname"
		 FROM tb_finance_expenses_temp t
		where t.excel_id=#{excelId}
		and t.record_status = 1
    </select>


    <!--保存 到支出记录表-->
    <insert id="saveMarkData" parameterType="java.util.Map">
        insert into tb_finance_expenses_month (cost_happend_time,cost,cost_after_type_id,cost_after_type_name,department_id,department_name,creator_account,created_time) values
        <foreach collection="list" item="item" index="index" open="" close="" separator=",">
            (
            <choose>
                <when test="item.costHappendTime != null" >
                    '${item.costHappendTime}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.cost != null" >
                    '${item.cost}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costAfterTypeId != null" >
                    '${item.costAfterTypeId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.costAfterTypeName != null" >
                    '${item.costAfterTypeName}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.departmentId != null" >
                    '${item.departmentId}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.departmentName != null" >
                    '${item.departmentName}',
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            #{account},
            SYSDATE()
            )
        </foreach>
    </insert>

    <!--费用类型查询-->
    <select id="selectFinanceType" parameterType="java.lang.String" resultType="com.jn.park.finance.vo.FinanceExpendFinanceTypeVo">
        SELECT t.id as "id",t.finance_name as "financename"
        FROM tb_finance_type t
        where t.record_status='1'
        ORDER by  t.show_order
    </select>

    <!--根据导入的费用类型对比，看是否有相同的费用类型-->
    <select id="selectAfterTypeName" resultType="com.jn.park.finance.model.FinanceExpensesTypeNameModel">

        select t.id as "costAfterTypeId",
        t.finance_name as "costAfterTypeName"
        from tb_finance_type t
        where t.finance_name=#{costBeforeTypeName}
        AND t.record_status=1

    </select>


</mapper>